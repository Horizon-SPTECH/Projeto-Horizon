<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Horizon</title>
    <link rel="shortcut icon" href="assets/group11.png" type="image/x-icon">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
</head>
<body onload="inicializarPagina()">
    <div class="background">

        <div class="container">

            <div class="container-barra-lateral">
                <div class="cbl-logo">
                    <img src="assets/group11.png" alt="">
                </div>

                <div class="cbl-botoes">

                    <div class="cbl-botoes-barralateral">
                        <div class="bl-botao" id="bl-botao-inicio">
                            <div class="bl-botao-filho">
                                <img src="assets/casa.png" alt="">
                                <span>Dashboard</span>
                            </div>
                        </div>
                        <a href="lista-municipios.html" class="bl-botao">
                            <div class="bl-botao-filho">
                                <img src="assets/detalhe1.png" alt="">
                                <span>Detalhes</span>
                            </div>
                        </a>

                        <a href="alterar-senha.html" class="bl-botao">
                            <div class="bl-botao-filho">
                                <img src="assets/cadeado.png" alt="">
                                <span>Alterar senha</span>
                            </div>
                        </a>

                        <a href="cadastro-funcionario.html" class="bl-botao">
                            <div class="bl-botao-filho">
                                <img src="assets/add.png" alt="">
                                <span>Novo usuário</span>
                            </div>
                        </a>
                        
                    </div>

                    <a href="index.html" class="bl-botao">
                        <div class="bl-botao-filho">
                            <img src="assets/porta.png" alt="">
                            <span>Sair</span>
                        </div>
                    </a>

                </div>

            </div>

            <div class="container-graficos-kpis">

                <div class="cgk-navbar">
                    <span>Boas vindas Lucas Moura!</span>
                </div>

                <div class="cgk-mapa-kpi">

                    <div class="cgk-mapa">
                        <div class="cgk-mapa-titulo">
                            <span>Regiões do Espírito Santo com mais furtos</span>
                        </div>

                        <div class="cgk-mapa-infos">
                            <div class="cgk-mapa-infos-class" id="cgk-mapa-infos-grafico">
                                <div id="map"></div>
                                
                                <div class="cgk-mapa-infos-legenda">
                                    <div class="cgk-mapa-legenda">
                                        <img src="assets/razoave.png" alt="">
                                        <span>Razoável</span>    
                                    </div> 

                                    <div class="cgk-mapa-legenda">
                                        <img src="assets/alerta.png" alt="">
                                        <span>Alerta</span>
                                    </div>

                                    <div class="cgk-mapa-legenda">
                                        <img src="assets/critico.png" alt="">
                                        <span>Crítico</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="cgk-mapa-infos-class" id="cgk-mapa-infos-kpi">
                                <div class="cgk-kpi-furto">
                                    <span>Município com mais furtos</span>
                                    <h1 id="kpiMunicipioComMaisFurto"></h1>
                                    <h1 id="kpiMunicipioComMaisFurtoDados"></h1>
                                </div>
                                
                                <div class="cgk-kpi-furto">
                                    <span>Município com menos furtos</span>
                                    <h1 id="kpiMunicipioComMenosFurto"></h1>
                                    <h1 id="kpiMunicipioComMenosFurtoDados"></h1>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="cgk-kpi">
                        <div class="cgk-kpi-furtosHab" id="cgk-kpi-id">
                            <div class="cgk-kpi-furtosHab-img">
                                <img src="assets/kpi-pessoas.png" alt="">
                            </div>

                            <div class="cgk-kpi-furtosHab-kpi">
                                <h3 style="font-size: 15px;">Furtos por 1k/habitante</h3>
                                <span id="kpiFurtosPor1k"></span>
                            </div>
                        </div>

                        <div class="cgk-kpi-obj" id="cgk-kpi-id">
                            <div class="cgk-kpi-obj-titulo">
                                <span>Objetos mais furtados</span>
                            </div>
                            
                            <div class="cgk-kpi-obj-imgs">
                                <!-- <h1>2° - 435</h1> -->

                            </div>
                        </div>
                    </div>

                </div>

                <div class="cgk-graficos-kpi">
                    <div class="cgk-grafico-periodo" id="cgk-graficos-id">
                        <div class="cgk-grafico-texto">
                            <h1>Período do dia com mais furtos</h1>
                        </div>

                        <div class="cgk-grafico-canvas">
                            <canvas id="grafico_periodo" style="height: 90%; width: 90%;"></canvas>
                        </div>
                    </div>

                    <div class="cgk-grafico-meses" id="cgk-graficos-id">
                        <div class="cgk-grafico-texto">
                            <h1>Meses com mais furto</h1>
                        </div>

                        <div class="cgk-grafico-canvas">
                            <canvas id="grafico_meses" style="height: 90%; width: 90%;"></canvas>
                        </div>
                    </div>

                    <div class="cgk-grafico-IA">
                        <div class="cgk-grafico-IA-texto">
                            <h1>Recomendação</h1>
                            <span>Aumente a visibilidade policial em áreas de risco identificadas. Considere o aumento do patrulhamento ostensivo em Serra, principalmente nos horários de pico</span>
                        </div>
                    </div>
                </div>

            </div>

        </div>

    </div>
</body>
</html>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

    function inicializarPagina(){
        maiorMunicipioFurtos();
        maiorMunicipioFurtosNumeroPorcentagem();
        menorMunicipioFurtos();
        menorMunicipioFurtosNumeroPorcentagem();
        furtorPor1kilometro(),
        objetosRoubados(),
        fetchPeríodoDiaComMaisFurtos()
    }

    function maiorMunicipioFurtos(){
        fetch(`/empresas/maisFurto`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    
                    const municipioElemento = document.getElementById('kpiMunicipioComMaisFurto');
                    municipioElemento.innerHTML = `${resposta[0].municipio}`
                    
                });
            } else {
                console.error('Erro no maiorMunicipioFurtos');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ KPI: ${error.message}`);
            });
    }

    function maiorMunicipioFurtosNumeroPorcentagem(){
        fetch(`/empresas/maisFurtoMunicipioPorcentagem`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                    const municipioMaiorDadosElemento = document.getElementById('kpiMunicipioComMaisFurtoDados');
                    municipioMaiorDadosElemento.innerHTML += `${resposta[0].numero_furtos} - ${resposta[0].porcentagem_furtos}%`
                });
            } else {
                console.error('Erro no maiorMunicipioFurtosNumeroPorcentagem');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ KPI: ${error.message}`);
            });
    }

    function menorMunicipioFurtos(){
        fetch(`/empresas/menosFurto`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    
                 const municipioMenorElemento = document.getElementById('kpiMunicipioComMenosFurto');
                 municipioMenorElemento.innerHTML = `${resposta[0].municipio}`
                    
                });
            } else {
                console.error('Erro no menorMunicipioFurtos');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ KPI: ${error.message}`);
            });
    }

    function menorMunicipioFurtosNumeroPorcentagem(){
        fetch(`/empresas/menosFurtoMunicipioPorcentagem`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                    const municipioMenorDadosElemento = document.getElementById('kpiMunicipioComMenosFurtoDados');
                    municipioMenorDadosElemento.innerHTML += `${resposta[0].numero_furtos} - ${resposta[0].porcentagem_furtos}%`

                });
            } else {
                console.error('Erro no menorMunicipioFurtosNumeroPorcentagem');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ KPI: ${error.message}`);
            });
    }

    function furtorPor1kilometro(){
        fetch(`/empresas/furtosPor1kilometro`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                    const municipioMenorDadosElemento = document.getElementById('kpiFurtosPor1k');
                    municipioMenorDadosElemento.innerHTML += `${resposta[0].furtos_por_km2}`

                });
            } else {
                console.error('Erro no furtorPor1kilometro');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ KPI: ${error.message}`);
            });
    }

   function objetosRoubados(){
    fetch(`/empresas/objetosMaisRoubados`, { cache: 'no-store' }).then(function (response) {
        if (response.ok) {
            response.json().then(function (resposta) {
                console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                   const container = document.querySelector('.cgk-kpi-obj-imgs');
                   container.innerHTML = '';
                   var contador = 1;
   
                   resposta.forEach((objeto, index) => {

                       const divOrdem = document.createElement('div');
                       divOrdem.classList.add('cgk-kpi-obj-ordem');
                       
                       const img = document.createElement('img');
                       img.src = `assets/${objeto.tipo_objeto.toLowerCase()}.png`;
                       img.alt = objeto.tipo_objeto;

                       const h1 = document.createElement('h1');
                       h1.innerHTML = `${contador++}º - ${objeto.numero_furtos}`;
   
                       const span = document.createElement('span');
                       span.innerHTML = objeto.tipo_objeto;
   
                       divOrdem.appendChild(img);
                       divOrdem.appendChild(h1);
                       divOrdem.appendChild(span);

                       container.appendChild(divOrdem);
                   });

            });
        } else {
            console.error('Erro no furtorPor1kilometro');
        }
    })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ KPI: ${error.message}`);
        });
   }


function fetchPeríodoDiaComMaisFurtos() {

    Promise.all([
        fetch('/empresas/mesesGraficos', { cache: 'no-store' }).then(response => response.json()),
        fetch(`/empresas/horarioMeses`, { cache: 'no-store' }).then(response => response.json())
    ])
        .then(([mesesGraficos, horarioMeses]) => {
            console.log('Meses Gráficos:', mesesGraficos);
            console.log('Horário Meses:', horarioMeses);

             plotar(mesesGraficos, horarioMeses);
        })
        .catch(error => console.error(`Erro na obtenção dos dados: ${error.message}`));
}



function plotar(mesesGraficos, horarioMeses) {
    const grafico_periodo = document.getElementById('grafico_periodo');

    const mesesLabels = mesesGraficos.map(mes => mes.nome_mes);
    const horas = horarioMeses.map(horario => horario.hora);

    Chart.defaults.color = '#23005B';
    //Chart.defaults.borderColor = 'white';

    new Chart(grafico_periodo, {
    type: 'bar',
    data: {
        labels: mesesLabels,
        datasets: [{
            label: 'Periodo',
            data: horas,
            backgroundColor: '#5321CA',
            borderRadius: 17
        }]
    },
    options: {
        responsive: false,
        maintainAspectRatio: false,
        scales: {
        y: {
        beginAtZero: true,
        ticks: {
            color: '#979699'
        },
        grid: {
            display: true,
            color: 'rgba(128, 128, 128, 0.2)'
        }
        },
        x: {
            ticks: {
            color: '#979699'
        },
        grid: {
            display: false
        }
        }
    },
    plugins: {
        legend: {
        display: false
        }
    },
    barPercentage: 0.4
    }});
}

    const grafico_meses = document.getElementById('grafico_meses');

    new Chart(grafico_meses, {
    type: 'bar',
    data: {
        labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
        datasets: [{
            label: 'Meses',
            data: [12, 19, 3, 5, 2, 3],
            backgroundColor: '#5321CA',
            borderRadius: 17
        }]
    },
    options: {
        responsive: false,
        maintainAspectRatio: false,
        scales: {
        y: {
        beginAtZero: true,
        ticks: {
            color: '#979699'
        },
        grid: {
            display: true,
            color: 'rgba(128, 128, 128, 0.2)'
        }
        },
        x: {
            ticks: {
            color: '#979699'
        },
        grid: {
            display: false
        }
        }
    },
    plugins: {
        legend: {
        display: false
        }
    },
    barPercentage: 0.4
    }});

    // Coordenadas do sudoeste e nordeste do Espírito Santo para definir o foco apenas no estado
    var bounds = [
            [-21.469103, -41.684086], // Sudoeste do Espírito Santo (limite com o Rio de Janeiro)
            [-17.826600, -39.978290]  // Nordeste do Espírito Santo (próximo ao limite com a Bahia)
        ];

        // Criar o mapa Leaflet focado no Espírito Santo, restringindo os limites do estado
        var map = L.map('map', {
            maxBounds: bounds, // Limitar a movimentação do mapa dentro do estado
            minZoom: 4.5, // Zoom mínimo permitido para impedir a visualização do Brasil inteiro
            maxZoom: 8, // Zoom máximo para visualização detalhada
            zoomSnap: 0.5 // Permitir zoom intermediário
        }).fitBounds(bounds); // Ajusta o mapa para os limites definidos

        // Adicionar um fundo branco para as áreas fora do Espírito Santo
        L.rectangle([[-90, -180], [90, 180]], { color: "#ffffff", weight: 0, fillOpacity: 1 }).addTo(map);

        // Adicionar o mapa base do OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        }).addTo(map);

        // Definir a quantidade de furtos por município
        var furtosPorMunicipio = {
            "Afonso Claudio": 0,
            "Água Doce do Norte": 0,
            "Anchieta": 0,
            "Apiacá": 0,
            "Aracruz": 0,
            "Atilio Vivacqua": 0,
            "Baixo Guandu": 0,
            "Barra de São Francisco": 0,
            "Boa Esperança": 0,
            "Bom Jesus do Norte": 0,
            "Brejetuba": 0,
            "Cachoeiro de Itapemirim": 0,
            "Cariacica": 0,
            "Castelo": 0,
            "Colatina": 0,
            "Divino de São Lourenço": 0,
            "Domingos Martins": 0,
            "Dores do Rio Preto": 0,
            "Ecoporanga": 0,
            "Fundão": 0,
            "Governador Lindenberg": 0,
            "Guaçuí": 0,
            "Ibatiba": 0,
            "Ibiporã": 500,
            "Iconha": 0,
            "Itaguaçu": 0,
            "Itapemirim": 0,
            "Itarana": 0,
            "Jaguaré": 1000,
            "Jerônimo Monteiro": 0,
            "João Neiva": 0,
            "Laranja da Terra": 0,
            "Linhares": 2000,
            "Mantenópolis": 0,
            "Marataízes": 0,
            "Marechal Floriano": 0,
            "Monjolos": 0,
            "Nova Venécia": 0,
            "Pancas": 0,
            "Pedro Canário": 0,
            "Pinheiros": 0,
            "Piúma": 0,
            "Rio Bananal": 0,
            "Santa Teresa": 0,
            "Santa Maria de Jetibá": 0,
            "São Domingos do Norte": 0,
            "São Gabriel da Palha": 0,
            "São José do Calçado": 0,
            "São Mateus": 0,
            "São Roque do Canaã": 10,
            "Serra": 0,
            "Silva Jardim": 0,
            "Vargem Alta": 0,
            "Vila Pavão": 0,
            "Vila Velha": 0,
            "Vitória": 0
            // Adicione os furtos de cada município aqui
        };

        // Carregar os limites dos municípios do Espírito Santo usando o GeoJSON
        fetch('../ES_Municipios_2022.json')        // Substitua pelo caminho correto do GeoJSON
            .then(response => response.json()) // Espera a resposta do fetch e converte para JSON
            .then(data => {
                // Adiciona o GeoJSON ao mapa
                L.geoJSON(data, {
                    style: function (feature) {
                        var municipio = feature.properties.NM_MUN; // Nome do município no GeoJSON
                        var furtos = furtosPorMunicipio[municipio] || 0; // Número de furtos do município, ou 0 se não houver

                        // Definir a cor com base no número de furtos
                        if (furtos >= 2000) {
                            return { fillColor: 'red', color: 'blue', weight: 1, fillOpacity: 0.7 }; // Alta incidência de furtos
                        } else if (furtos >= 1000) {
                            return { fillColor: 'orange', color: 'blue', weight: 1, fillOpacity: 0.7 }; // Média incidência de furtos
                        } else if (furtos >= 100) {
                            return { fillColor: 'yellow', color: 'blue', weight: 1, fillOpacity: 0.7 }; // Baixa incidência de furtos
                        } else {
                            return { fillColor: 'green', color: 'blue', weight: 1, fillOpacity: 0.7 }; // Poucos furtos
                        }
                    },
                    onEachFeature: function (feature, layer) { // Adiciona um evento para cada recurso (município)
                        layer.on({
                            mouseover: function (e) { // Evento de mouse sobre o município
                                var layer = e.target; // Camada atual do evento
                                var municipio = feature.properties.NM_MUN; // Nome do município
                                var furtos = furtosPorMunicipio[municipio] || 0; // Número de furtos
                                // Cria conteúdo do popup
                                var popupContent = "<b>" + municipio + "</b><br>Furtos: " + furtos;
                                layer.bindPopup(popupContent).openPopup(); // Cria e abre o popup
                            }
                        });
                    }
                }).addTo(map); // Adiciona o GeoJSON ao mapa
            });
</script>