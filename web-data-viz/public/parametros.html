<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parâmetros - Horizon</title>
    <link rel="shortcut icon" href="assets/group11.png" type="image/x-icon">
    <link rel="stylesheet" href="css/parametros.css">
    <link rel="stylesheet" href="css/dashboard-indiv.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="js/block-screan.js"></script>
</head>

<body onload="mostrarParametro(),acessar(),cargo()">
    <div class="background">

        <div class="container">

            <div class="container-barra-lateral">
                <div class="cbl-logo">
                    <img src="assets/group11.png" alt="">
                </div>

                <div class="cbl-botoes">

                    <div class="cbl-botoes-barralateral">
                        <a href="dashboard.html" class="bl-botao">
                            <div class="bl-botao-filho">
                                <img src="assets/casa.png" alt="">
                                <span>Dashboard</span>
                            </div>
                        </a>
                        <a href="lista-municipios.html" class="bl-botao">
                            <div class="bl-botao-filho">
                                <img src="assets/detalhe1.png" alt="">
                                <span>Detalhes</span>
                            </div>
                        </a>

                        <a href="perfil.html" class="bl-botao">
                            <div class="bl-botao-filho">
                                <img src="assets/icon-user.png" alt="">
                                <span>Perfil</span>
                            </div>
                        </a>

                        <a href="empresa.html" class="bl-botao">
                            <div class="bl-botao-filho">
                                <img src="assets/icon-empresa.png" alt="">
                                <span>Empresa</span>
                            </div>
                        </a>
                        <a href="lista-funcionario.html" class="bl-botao">
                            <div class="bl-botao-filho">
                                <img src="assets/icon-search.png" alt="">
                                <span>Funcionários</span>
                            </div>
                        </a>

                        <a href="cadastro-funcionario.html" class="bl-botao">
                            <div class="bl-botao-filho">
                                <img src="assets/add.png" alt="">
                                <span>Novo usuário</span>
                            </div>
                        </a>
                        <a href="parametros.html" class="bl-botao" id="bl-botao-inicio">
                            <div class="bl-botao-filho">
                                <img src="assets/parameter.png" alt="">
                                <span>Parametrização</span>
                            </div>
                        </a>
                    </div>

                    <a onclick="limparSession()" href="index.html" class="bl-botao">
                        <div class="bl-botao-filho">
                            <img src="assets/porta.png" alt="">
                            <span>Sair</span>
                        </div>
                    </a>

                </div>

            </div>

            <div class="container-graficos-kpis">

                <div class="cgk-navbar">
                    <span>Parâmetros de mapa:</span>
                </div>


                <div class="card-parametro">
                    <div class="card-info">
                        <header>Informações:</header>
                        <div class="box-recomendacao-info">
                            <div class="title-recomendacao">
                                <img src="assets/razoave.png" alt="">
                                <span>Regular</span>
                            </div>
                            <span>Indica uma quantidade de furtos <b>dentro de um padrão aceitável</b>, sem necessidade
                                de
                                medidas imediatas.</span>
                        </div>

                        <div class="box-recomendacao-info">
                            <div class="title-recomendacao">
                                <img src="assets/alerta.png" alt="">
                                <span>Alerta</span>
                            </div>
                            <span>Reflete uma quantidade de furtos que pode gerar <b>preocupações</b>, sugerindo a
                                necessidade
                                de monitoramento mais <b>atento</b>.</span>
                        </div>
                        <div class="box-recomendacao-info">
                            <div class="title-recomendacao">
                                <img src="assets/critico.png" alt="">
                                <span>Crítico</span>
                            </div>
                            <span>Aponta para um número <b>elevado de furtos</b>, exigindo ações <b>urgentes</b> para
                                mitigar
                                os
                                riscos e prevenir novos incidentes.</span>
                        </div>

                    </div>
                    <div class="card-progress-box">
                        <div class="card-white-progress">
                            <span class="title-card-white">Parâmetros Padrão Horizon</span>
                            <div class="progress-container">
                                <div class="progress-bar">
                                    <div class="segment reasonable">Razoável</div>
                                    <div class="segment alert">Alerta</div>
                                    <div class="segment critical">Crítico</div>
                                    <div class="divisions">
                                        <div class="division"></div>
                                        <div class="division"></div>
                                        <div class="division"></div>
                                        <div class="division"></div>
                                        <div class="division"></div>
                                        <div class="division"></div>
                                        <div class="division"></div>
                                        <div class="division"></div>
                                        <div class="division"></div>
                                    </div>
                                </div>
                                <div class="division-labels">
                                    <span>1%</span>
                                    <span>2%</span>
                                    <span>3%</span>
                                    <span>4%</span>
                                    <span>5%</span>
                                    <span>6%</span>
                                    <span>7%</span>
                                    <span>8%</span>
                                    <span>9%</span>
                                    <span>10%</span>
                                </div>
                            </div>
                        </div>
                        <div class="box-white">
                            <header class="box-title">
                                <p>Defina os percentuais aceitáveis para categorizar a situação dos furtos:
                                </p>
                            </header>
                            <div class="card-recomendacao">
                                <div class="recomendacao">

                                    <div class="title-recomendacao">
                                        <img src="assets/razoave.png" alt="">
                                        <span>Regular</span>

                                    </div>
                                    <main class="text-recomendacao">
                                        <span>O percentual atual é: </span>
                                        <b id="percentualRegular">7%</b>
                                    </main>
                                </div>
                                <div class="recomendacao">
                                    <div class="title-recomendacao">
                                        <img src="assets/alerta.png" alt="">
                                        <span>Alerta</span>
                                    </div>
                                    <main class="text-recomendacao">
                                        <span>O percentual atual é: </span>
                                        <b id="percentualAlerta">7%</b>

                                    </main>
                                </div>
                                <div class="recomendacao">
                                    <div class="title-recomendacao">
                                        <img src="assets/critico.png" alt="">
                                        <span>Critico</span>

                                    </div>
                                    <main class="text-recomendacao">
                                        <span>O percentual atual é: </span>
                                        <b>></b><b id="percentualCritico">7%</b>
                                    </main>
                                </div>

                            </div>
                            <div class="content-box">
                                <button id="toggle-progress">Ver informações</button>
                                <button id="toggle-criar">Criar Parâmetro</button>
                                <button id="toggle-excluir">Excluir Parâmetro</button>

                            </div>

                        </div>
                    </div>
                    <div class="card-info-criar">
                        <header>Cadastro de novo parâmetro:</header>
                        <div class="box-recomendacao-info">
                            <div class="title-recomendacao">
                                <img src="assets/razoave.png" alt="">
                                <span>Regular</span>
                            </div>
                            <span>Insira um novo valor:</span>
                            <input type="number" id="limiteBaixo">
                        </div>

                        <div class="box-recomendacao-info">
                            <div class="title-recomendacao">
                                <img src="assets/alerta.png" alt="">
                                <span>Alerta</span>
                            </div>
                            <span>Insira um novo valor:</span>
                            <input type="number" id="limiteOk">
                        </div>
                        <div class="box-recomendacao-info">
                            <div class="title-recomendacao">
                                <img src="assets/critico.png" alt="">
                                <span>Crítico</span>
                            </div>
                            <span></span>
                        </div>
                        <button id="toggle-criar-parametro" onclick="atualizarParametro() ">Criar</button>
                        <span id="texto-ajuda">Não deixe de ver as informações para definir o melhor
                            parâmetro!</span>
                    </div>

                </div>
            </div>

        </div>

    </div>
</body>

</html>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const toggleButton = document.getElementById("toggle-progress");
        const progressCard = document.querySelector(".card-white-progress");

        toggleButton.addEventListener("click", () => {
            progressCard.classList.toggle("show");
        });
    });

    document.addEventListener("DOMContentLoaded", () => {
        const toggleProgressButton = document.getElementById("toggle-progress");
        const cardInfo = document.querySelector(".card-info");

        toggleProgressButton.addEventListener("click", () => {
            cardInfo.classList.toggle("show");
        });
    });
    document.addEventListener("DOMContentLoaded", () => {
        const toggleCriarButton = document.getElementById("toggle-criar");
        const cardInfoCriar = document.querySelector(".card-info-criar");

        toggleCriarButton.addEventListener("click", () => {
            cardInfoCriar.classList.toggle("show");
        });
    });


    document.addEventListener("DOMContentLoaded", () => {
        // IDs dos inputs que precisam de validação
        const inputIds = ["limiteBaixo", "limiteOk"];

        inputIds.forEach(id => {
            const input = document.getElementById(id);

            if (input) {
                input.addEventListener("input", () => {
                    let value = input.value.replace(/[^0-9]/g, '');

                    if (value > 100) {
                        value = '100';
                    } else if (value < 1) {
                        value = '';
                    } else if (value.length > 1 && value.startsWith('0')) {
                        value = value.replace(/^0+/, '');
                    }

                    input.value = value;
                });
            }
        });
    });

    document.addEventListener("DOMContentLoaded", () => {
        const toggleCardInfoButton = document.getElementById("toggle-excluir");;

        toggleCardInfoButton.addEventListener("click", () => {
            const swalWithBootstrapButtons = Swal.mixin({
                customClass: {
                    confirmButton: "btn btn-success",
                    cancelButton: "btn btn-danger"
                },
                buttonsStyling: false
            });
            swalWithBootstrapButtons.fire({
                title: "Você tem certeza?",
                text: "Isso retornará o seus parâmetros para o padrão Horizon!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Sim, excluir!",
                cancelButtonText: "Não, cancelar!",
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    padronizarParametro();
                    swalWithBootstrapButtons.fire({
                        title: "Deletado!",
                        text: "O seu parâmetro foi deletado, e levado ao nosso padrão.",
                        icon: "success"
                    });
                } else if (
                    /* Read more about handling dismissals below */
                    result.dismiss === Swal.DismissReason.cancel
                ) {
                    swalWithBootstrapButtons.fire({
                        title: "Cancelado",
                        text: "Seus parâmetros seguem os mesmos não se preocupe :)",
                        icon: "error"
                    });
                }
            });
        });
    });

    function alertCriarParametro(){
        document.addEventListener("DOMContentLoaded", () => {
        const toggleCriarParametro = document.getElementById("toggle-criar-parametro");

        if (toggleCriarParametro) {
            const Toast = Swal.mixin({
                toast: true,
                position: "top-end",
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.onmouseenter = Swal.stopTimer;
                    toast.onmouseleave = Swal.resumeTimer;
                }
            });

            toggleCriarParametro.addEventListener("click", () => {
                Toast.fire({
                    icon: "success",
                    title: "Cadastrado com sucesso"
                });
            });
        }
    });
    }
    

</script>


<script>

function atualizarParametro() {
    const idEmpresa = sessionStorage.getItem("ID_EMPRESA");
    const limiteBaixo = document.getElementById('limiteBaixo').value;
    const limiteOk = document.getElementById('limiteOk').value;

    // Função de validação para garantir números de 1 a 2 dígitos
    function validarEntrada(valor) {
        const regex = /^[0-9]{1,2}$/; // Apenas números de 1 ou 2 dígitos
        return regex.test(valor);
    }

    // Verificar se os campos são válidos
    if (!validarEntrada(limiteBaixo) || !validarEntrada(limiteOk)) {
        Swal.fire({
            icon: 'error',
            title: 'Entrada Inválida!',
            text: 'Certifique-se de que os campos contenham apenas números de até 2 dígitos e não estejam vazios.',
            confirmButtonText: 'Ok'
        });
        return;
    }

    // Verificar se limiteBaixo é menor que limiteOk e que os dois não sejam iguais
    if (parseInt(limiteBaixo) >= parseInt(limiteOk)) {
        Swal.fire({
            icon: 'error',
            title: 'Configuração Inválida!',
            text: 'O valor do Limite Baixo deve ser menor que o Limite Ok, e os dois valores não podem ser iguais.',
            confirmButtonText: 'Ok'
        });
        return;
    }

    fetch('/parametros/atualizarParametro', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            id_empresa: idEmpresa,
            limite_baixo: limiteBaixo,
            limite_ok: limiteOk,
        }),
    })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Erro ao atualizar parâmetro');
            }
        })
        .then(data => {
            console.log('Parâmetros atualizados com sucesso:', data);

            // Exibir alerta de sucesso ao criar parâmetro
            const Toast = Swal.mixin({
                toast: true,
                position: "top-end",
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.onmouseenter = Swal.stopTimer;
                    toast.onmouseleave = Swal.resumeTimer;
                }
            });

            Toast.fire({
                icon: "success",
                title: "Cadastrado com sucesso"
            });

            atualizarPagina(); // Atualizar a página
            mostrarParametro(); // Recarregar os parâmetros
        })
        .catch(error => {
            console.error('Erro ao atualizar parâmetros:', error);
        });
}



    function padronizarParametro() {
        const idEmpresa = sessionStorage.getItem("ID_EMPRESA");
        const empresa = `?id_empresa=${idEmpresa}`;

        fetch(`/parametros/padronizarParametro`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                id_empresa: idEmpresa,
            }),
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Erro ao padronizar parâmetros');
                }
            })
            .then(data => {
                console.log('Parâmetros padronizados com sucesso:', data);
                atualizarPagina()
                mostrarParametro()
            })
            .catch(error => {
                console.error('Erro ao padronizar parâmetros:', error);
            });
    }

    function mostrarParametro() {
        const idEmpresa = sessionStorage.getItem("ID_EMPRESA");
        const empresa = `?id_empresa=${idEmpresa}`;

        fetch(`/parametros/mostrarParametro${empresa}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao obter parâmetros: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                console.log('Parâmetros:', data);

                if (Array.isArray(data) && data.length > 0) {
                    const parametros = data[0];

                    if (
                        parametros.limite_baixo !== undefined &&
                        parametros.limite_ok !== undefined &&
                        parametros.limite_alto !== undefined
                    ) {
                        sessionStorage.setItem('limite_baixo', parametros.limite_baixo);
                        sessionStorage.setItem('limite_ok', parametros.limite_ok);
                        sessionStorage.setItem('limite_alto', parametros.limite_alto);
                        console.log('Limites salvos no sessionStorage.');
                    } else {
                        console.warn('Os campos esperados não estão presentes:', parametros);
                    }
                } else {
                    console.warn('Os dados retornados não são válidos:', data);
                }
            })
            .catch(error => {
                console.error('Erro ao buscar parâmetros:', error);
            });
    }


    const limiteBaixo = sessionStorage.getItem('limite_baixo');
    const limiteOk = sessionStorage.getItem('limite_ok');
    const limiteAlto = sessionStorage.getItem('limite_alto');

    if (limiteBaixo == null || limiteOk == null || limiteAlto == null) {
        document.getElementById('percentualRegular').innerHTML = '4';
        document.getElementById('percentualAlerta').innerHTML = '6';
        document.getElementById('percentualCritico').innerHTML = '6';
    } else {
        document.getElementById('percentualRegular').innerHTML = limiteBaixo;
        document.getElementById('percentualAlerta').innerHTML = limiteOk;
        document.getElementById('percentualCritico').innerHTML = limiteOk;
    }


    function atualizarPagina() {
        setTimeout(function () {
            window.location = "parametros.html";
        }, 2000);
    }
</script>